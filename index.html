<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังรับชม | DUYDODEE-HD</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #00f2ff;
            --bg-dark: #050507;
            --bg-surf: #121216;
            --text-muted: #9ca3af;
            --nav-h: 70px;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: #fff; line-height: 1.6; overflow-x: hidden; }

        /* Navigation */
        nav {
            position: fixed; top: 0; width: 100%; height: var(--nav-h);
            padding: 0 5%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(5, 5, 7, 0.9); backdrop-filter: blur(15px); z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); cursor: pointer; text-decoration: none; text-transform: uppercase; }
        .nav-back { color: var(--text-muted); cursor: pointer; text-decoration: none; font-size: 14px; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-back:hover { color: var(--primary); transform: translateX(-5px); }

        /* Layout */
        .player-layout {
            margin: calc(var(--nav-h) + 25px) auto 60px; padding: 0 5%;
            max-width: 1500px; display: grid; grid-template-columns: 1fr 350px; gap: 35px;
        }

        /* Player & Episodes */
        .video-box { position: relative; padding-bottom: 56.25%; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
        .video-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }

        .ep-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        .ep-btn { 
            background: #1a1a1e; color: var(--text-muted); border: 1px solid #333;
            padding: 8px 18px; border-radius: 8px; cursor: pointer; font-family: inherit; transition: 0.3s;
        }
        .ep-btn.active { background: var(--primary); color: #000; font-weight: 600; border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }

        /* Movie Info */
        .info-card { margin-top: 30px; background: var(--bg-surf); padding: 30px; border-radius: 12px; }
        .m-title { font-size: clamp(20px, 4vw, 28px); margin: 0; font-weight: 700; }
        .meta { display: flex; flex-wrap: wrap; gap: 20px; font-size: 13px; color: var(--text-muted); margin: 20px 0; align-items: center; }
        .badge { background: #ff0055; color: #fff; padding: 2px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .desc { font-size: 14px; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; white-space: pre-line; }

        /* Sidebar Suggestions */
        .side-title { font-size: 18px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 15px; }
        .suggest-card { display: flex; gap: 15px; background: var(--bg-surf); padding: 10px; border-radius: 10px; cursor: pointer; transition: 0.3s; margin-bottom: 15px; border: 1px solid transparent; }
        .suggest-card:hover { transform: translateX(5px); background: #1a1a1e; border-color: rgba(0, 242, 255, 0.2); }
        .suggest-card img { width: 75px; aspect-ratio: 2/3; object-fit: cover; border-radius: 6px; }
        .suggest-card img.vertical { aspect-ratio: 9/16; width: 65px; }
        .suggest-info p { margin: 0; font-size: 14px; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .suggest-info span { font-size: 11px; color: var(--primary); display: block; margin-top: 5px; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: 0.4s; }
        .spin { width: 45px; height: 45px; border: 3px solid rgba(255,255,255,0.05); border-top-color: var(--primary); border-radius: 50%; animation: s 0.8s linear infinite; }
        @keyframes s { 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) {
            .player-layout { grid-template-columns: 1fr; }
            .suggest-card { background: transparent; padding: 0; }
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <p style="margin-top:20px; font-size:10px; letter-spacing:3px; color: var(--text-muted);">LOADING PLAYER</p>
</div>

<nav>
    <div class="logo" onclick="goHome()">DUY<span style="color:#fff">DODEE</span></div>
    <div class="nav-back" onclick="goHome()"><i class="fas fa-chevron-left"></i> กลับหน้าหลัก</div>
</nav>

<div class="player-layout">
    <main>
        <div class="video-box" id="player-box"></div>
        
        <div class="ep-list-container">
            <p style="font-weight:600; margin-bottom:12px; font-size:14px; margin-top: 20px;">เลือกตอนรับชม:</p>
            <div class="ep-list" id="ep-list"></div>
        </div>

        <div class="info-card">
            <h1 class="m-title" id="m-title">...</h1>
            <div class="meta">
                <span class="badge" id="m-badge">HD</span>
                <span><i class="far fa-eye" style="color:var(--primary)"></i> <span id="m-views">0</span> วิว</span>
                <span><i class="fas fa-star" style="color:#ffd700"></i> <span id="m-rating">8.5</span></span>
            </div>
            <div class="desc" id="m-desc">...</div>
        </div>
    </main>

    <aside>
        <h3 class="side-title">แนะนำสำหรับคุณ</h3>
        <div id="suggest-box"></div>
    </aside>
</div>

<!-- Firebase Logic (คงเดิมตามที่คุณกำหนด) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // การตั้งค่า Firebase เดิมของคุณ
    const firebaseConfig = {
        apiKey: "AIzaSyBuhTA1YwcsNyxR0NLYW6JrxUQ9U7vyVeo",
        authDomain: "classic-e8ab7.firebaseapp.com",
        projectId: "classic-e8ab7",
        appId: "1:596308927760:web:63043fd2786459082cb195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ระบบจัดการ URL เพื่อป้องกัน Error ใน Sandbox
    function goHome() {
        const url = new URL(window.location.href);
        url.searchParams.delete('id');
        window.history.pushState({}, '', url);
        window.location.reload();
    }

    function watchMovie(id) {
        const url = new URL(window.location.href);
        url.searchParams.set('id', id);
        window.history.pushState({}, '', url);
        window.location.reload();
    }

    const movieId = new URLSearchParams(window.location.search).get('id');

    function getEmbed(u) {
        if (!u) return "";
        let id = "";
        try {
            if (u.includes("youtu.be/")) {
                id = u.split("youtu.be/")[1].split(/[?#]/)[0];
            } else if (u.includes("v=")) {
                id = new URLSearchParams(new URL(u).search).get('v');
            } else if (u.includes("shorts/")) {
                id = u.split("shorts/")[1].split(/[?#]/)[0];
            }
        } catch(e) { return u; }
        return id ? `https://www.youtube.com/embed/${id}?autoplay=1&rel=0` : u;
    }

    async function init() {
        if(!movieId) { 
            const loader = document.getElementById('loader');
            loader.innerHTML = '<p style="color:var(--primary); font-size: 14px;">กรุณาเลือกวิดีโอจากหน้าหลัก</p>';
            return; 
        }
        
        try {
            const docRef = db.collection('artifacts').doc(movieId);
            const doc = await docRef.get();
            
            if(!doc.exists) {
                document.getElementById('loader').innerHTML = '<p style="color:red">ไม่พบข้อมูลเรื่องนี้</p>';
                return;
            }

            const d = doc.data();

            document.title = `${d.title} | DUYDODEE-HD`;
            document.getElementById('m-title').innerText = d.title;
            document.getElementById('m-badge').innerText = d.badge || 'HD';
            document.getElementById('m-views').innerText = (d.viewCount || 0).toLocaleString();
            document.getElementById('m-rating').innerText = d.rating || '8.5';
            document.getElementById('m-desc').innerText = d.desc || "ไม่มีข้อมูลเรื่องย่อ";

            const pBox = document.getElementById('player-box');
            const eList = document.getElementById('ep-list');
            
            // ใช้โครงสร้างข้อมูลเดิม (links หรือ link)
            let links = Array.isArray(d.links) ? d.links : (d.link ? [d.link] : []);

            if(links.length === 0) {
                pBox.innerHTML = `<div style="padding: 100px 20px; text-align:center; color:gray;">
                    <i class="fas fa-exclamation-circle" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>ขออภัย ไม่พบลิงก์วิดีโอสำหรับเรื่องนี้</p>
                </div>`;
            } else {
                links.forEach((url, i) => {
                    const b = document.createElement('button');
                    b.className = 'ep-btn';
                    b.innerText = links.length > 1 ? `EP ${i+1}` : `เล่นวิดีโอ`;
                    b.onclick = () => {
                        pBox.innerHTML = `<iframe src="${getEmbed(url)}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                        document.querySelectorAll('.ep-btn').forEach(btn => btn.classList.remove('active'));
                        b.classList.add('active');
                    };
                    eList.appendChild(b);
                    if(i === 0) b.click();
                });
            }

            // อัปเดตยอดวิว
            docRef.update({ viewCount: firebase.firestore.FieldValue.increment(1) });
            fetchSuggest(d.category);
            
        } catch(e) { 
            console.error("Error loading movie:", e); 
        } finally { 
            const ld = document.getElementById('loader');
            ld.style.opacity = '0';
            setTimeout(() => ld.style.display = 'none', 400);
        }
    }

    async function fetchSuggest(currentCategory) {
        const box = document.getElementById('suggest-box');
        try {
            const snap = await db.collection('artifacts')
                .where('category', '==', currentCategory)
                .limit(6)
                .get();
            
            let count = 0;
            snap.forEach(doc => {
                if(doc.id === movieId || count >= 5) return;
                const m = doc.data();
                addSuggestCard(box, doc.id, m);
                count++;
            });

            if(count < 5) {
                const extraSnap = await db.collection('artifacts').limit(8).get();
                extraSnap.forEach(doc => {
                    if(doc.id === movieId || count >= 6) return;
                    if(!box.querySelector(`[data-id="${doc.id}"]`)) {
                        addSuggestCard(box, doc.id, doc.data());
                        count++;
                    }
                });
            }
        } catch(e) { console.error("Error suggestions:", e); }
    }

    function addSuggestCard(container, id, m) {
        const c = document.createElement('div');
        c.className = 'suggest-card';
        c.setAttribute('data-id', id);
        c.onclick = () => watchMovie(id);
        c.innerHTML = `
            <img src="${m.poster}" class="${m.category === 'vertical' ? 'vertical' : ''}" onerror="this.src='https://via.placeholder.com/150x225?text=No+Image'">
            <div class="suggest-info">
                <p>${m.title}</p>
                <span><i class="fas fa-play-circle"></i> ${m.category === 'vertical' ? 'ซีรีส์สั้น' : 'พากย์ไทย'}</span>
            </div>
        `;
        container.appendChild(c);
    }

    window.onload = init;
</script>
</body>
</html>
