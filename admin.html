<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | DUYDODEE-HD</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #00e5ff; --bg-dark: #0a0a0c; --card-bg: #16161a;
            --input-bg: #1f1f23; --text-main: #ffffff; --text-dim: #9ca3af;
            --ai-color: #a855f7; --glass-border: rgba(255, 255, 255, 0.05); --error: #ef4444;
        }
        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; font-family: 'Prompt', sans-serif; 
            background: var(--bg-dark); color: var(--text-main);
            background-image: radial-gradient(circle at 0% 0%, rgba(0, 229, 255, 0.05) 0%, transparent 40%);
            min-height: 100vh; line-height: 1.6;
        }
        #aiLoading { 
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: var(--ai-color); color: white; padding: 12px 25px; 
            border-radius: 50px; z-index: 4000; display: none; 
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4); font-weight: 600;
        }
        #loginOverlay {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 3000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--card-bg); padding: 40px; border-radius: 20px;
            border: 1px solid var(--glass-border); text-align: center; max-width: 400px;
        }
        .btn-google {
            background: #fff; color: #333; border: none; padding: 12px 25px; border-radius: 50px;
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 20px auto 0;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; display: none; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .fetch-card { background: #1c101e; border: 1px solid var(--ai-color); margin-bottom: 25px; padding: 20px; border-radius: 16px; }
        .fetch-group { display: flex; gap: 10px; margin-top: 10px; }
        .form-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--glass-border); }
        .card-title { color: var(--primary); font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .input-group { margin-bottom: 18px; }
        .input-group label { display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--text-dim); font-size: 14px; }
        input, select, textarea {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border);
            background: var(--input-bg); color: #fff; font-family: 'Prompt'; transition: 0.3s;
        }
        .ai-btn { background: rgba(168, 85, 247, 0.1); color: var(--ai-color); border: 1px solid var(--ai-color); padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .btn-submit { background: var(--primary); color: #000; padding: 14px; border-radius: 10px; border: none; font-weight: 700; width: 100%; cursor: pointer; margin-top: 10px; }
        .episodes-area { background: #000; padding: 12px; border-radius: 10px; max-height: 250px; overflow-y: auto; }
        .ep-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .movie-table { width: 100%; border-collapse: collapse; }
        .movie-row { background: var(--card-bg); border-bottom: 8px solid var(--bg-dark); }
        .movie-row td { padding: 15px; }
        .poster-mini { width: 45px; height: 60px; border-radius: 6px; object-fit: cover; }
        .action-btn { padding: 8px; cursor: pointer; background: none; border: none; color: var(--text-dim); font-size: 16px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--primary); }
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; 
            border-radius: 50px; padding: 16px; position: fixed; z-index: 5000; left: 50%; transform: translateX(-50%); bottom: 30px; 
            border: 1px solid var(--primary); opacity: 0; transition: 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<div id="aiLoading">กำลังประมวลผล...</div>
<div id="toast">บันทึกข้อมูลสำเร็จ</div>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:var(--primary);">ADMIN ACCESS</h2>
        <p style="color:var(--text-dim);">เข้าสู่ระบบเพื่อจัดการเนื้อหา DUYDODEE</p>
        <button class="btn-google" id="btnLogin">
            <i class="fab fa-google"></i> เข้าสู่ระบบด้วย Google
        </button>
    </div>
</div>

<div class="container" id="dashboard">
    <div class="header-box">
        <h2><i class="fas fa-magic" style="color:var(--ai-color)"></i> ระบบจัดการ DUYDODEE</h2>
        <div style="display:flex; gap:15px; align-items:center;">
            <span id="adminEmail" style="font-size:12px; color:var(--text-dim);"></span>
            <button id="btnLogout" style="background:none; border:1px solid #333; color:#fff; padding:5px 10px; border-radius:5px; cursor:pointer;">Logout</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="totalViews">0</div><div class="stat-label">ยอดวิวรวม</div></div>
        <div class="stat-card"><div class="stat-value" id="totalSeries">0</div><div class="stat-label">จำนวนซีรีส์</div></div>
        <div class="stat-card"><div class="stat-value" id="totalEps">0</div><div class="stat-label">จำนวนตอนรวม</div></div>
    </div>

    <form id="movieForm">
        <input type="hidden" id="editId">
        <div class="form-grid">
            <div class="card">
                <div class="card-title"><i class="fas fa-file-alt"></i> ข้อมูลเนื้อหา</div>
                <div class="input-group">
                    <label>ชื่อเรื่อง</label>
                    <input type="text" id="title" required>
                </div>
                <div class="input-group">
                    <label>เรื่องย่อ <button type="button" class="ai-btn" id="btnAiDesc">AI ช่วยเขียน</button></label>
                    <textarea id="desc" rows="4"></textarea>
                </div>
                <div class="input-group">
                    <label>จัดการตอน (ลิงก์วิดีโอ)</label>
                    <div id="epContainer" class="episodes-area"></div>
                    <button type="button" class="ai-btn" style="width:100%; margin-top:10px;" id="btnAddEp">+ เพิ่มตอนใหม่</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-cog"></i> ตั้งค่า</div>
                <div class="input-group">
                    <label>หมวดหมู่</label>
                    <select id="category">
                        <option value="vertical">ซีรีส์สั้น (แนวตั้ง)</option>
                        <option value="series">ซีรีส์ยาว (พากย์ไทย)</option>
                    </select>
                </div>
                <div class="input-group"><label>URL รูปโปสเตอร์</label><input type="url" id="poster" required></div>
                <div class="input-group"><label>ป้ายกำกับ (Badge)</label><input type="text" id="badge" placeholder="เช่น พากย์ไทย"></div>
                <div class="input-group">
                    <label>สถานะ VIP</label>
                    <input type="checkbox" id="isVip" style="width:20px;"> จำกัดเฉพาะสมาชิก
                </div>
                <button type="submit" class="btn-submit" id="submitBtn">บันทึกข้อมูล</button>
                <button type="button" id="cancelBtn" style="display:none; width:100%; margin-top:10px; background:none; color:var(--text-dim); border:none; cursor:pointer;">ยกเลิกการแก้ไข</button>
            </div>
        </div>
    </form>

    <div style="margin-top:40px; overflow-x:auto;">
        <table class="movie-table">
            <tbody id="movieList"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 1. CONFIG: นำข้อมูลจาก Firebase Console มาวางที่นี่
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colRef = collection(db, "artifacts");

    // 2. AUTHENTICATION
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const loginOverlay = document.getElementById('loginOverlay');
    const dashboard = document.getElementById('dashboard');

    btnLogin.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    btnLogout.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginOverlay.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('adminEmail').innerText = user.email;
            loadData();
        } else {
            loginOverlay.style.display = 'flex';
            dashboard.style.display = 'none';
        }
    });

    // 3. EPISODE MANAGEMENT
    const epContainer = document.getElementById('epContainer');
    const addEpField = (val = "") => {
        const div = document.createElement('div');
        div.className = 'ep-row';
        div.innerHTML = `
            <input type="text" class="ep-link" placeholder="URL วิดีโอ" value="${val}" required>
            <button type="button" onclick="this.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">&times;</button>
        `;
        epContainer.appendChild(div);
    };
    document.getElementById('btnAddEp').onclick = () => addEpField();

    // 4. CRUD OPERATIONS
    const movieForm = document.getElementById('movieForm');
    movieForm.onsubmit = async (e) => {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        const links = Array.from(document.querySelectorAll('.ep-link')).map(input => input.value);
        
        const data = {
            title: document.getElementById('title').value,
            desc: document.getElementById('desc').value,
            category: document.getElementById('category').value,
            poster: document.getElementById('poster').value,
            badge: document.getElementById('badge').value,
            isVip: document.getElementById('isVip').checked,
            links: links,
            updatedAt: serverTimestamp()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, "artifacts", editId), data);
            } else {
                await addDoc(colRef, { ...data, createdAt: serverTimestamp(), viewCount: 0, isPublished: true });
            }
            showToast("บันทึกสำเร็จ!");
            resetForm();
        } catch (err) { alert(err.message); }
    };

    function loadData() {
        onSnapshot(query(colRef, orderBy("createdAt", "desc")), (snapshot) => {
            const list = document.getElementById('movieList');
            list.innerHTML = '';
            let totalV = 0, totalE = 0;

            snapshot.forEach(d => {
                const item = d.data();
                totalV += (item.viewCount || 0);
                totalE += (item.links ? item.links.length : 0);
                renderRow(d.id, item);
            });

            document.getElementById('totalSeries').innerText = snapshot.size;
            document.getElementById('totalViews').innerText = totalV.toLocaleString();
            document.getElementById('totalEps').innerText = totalE.toLocaleString();
        });
    }

    function renderRow(id, item) {
        const tr = document.createElement('tr');
        tr.className = 'movie-row';
        tr.innerHTML = `
            <td><img src="${item.poster}" class="poster-mini"></td>
            <td>
                <div style="font-weight:600;">${item.title}</div>
                <div style="font-size:12px; color:var(--text-dim);">${item.category} | ${item.links.length} ตอน</div>
            </td>
            <td style="text-align:right;">
                <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                <button class="action-btn del-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
            </td>
        `;
        
        tr.querySelector('.edit-btn').onclick = () => {
            document.getElementById('editId').value = id;
            document.getElementById('title').value = item.title;
            document.getElementById('desc').value = item.desc;
            document.getElementById('category').value = item.category;
            document.getElementById('poster').value = item.poster;
            document.getElementById('badge').value = item.badge;
            document.getElementById('isVip').checked = item.isVip;
            epContainer.innerHTML = '';
            item.links.forEach(l => addEpField(l));
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('submitBtn').innerText = 'อัปเดตข้อมูล';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        tr.querySelector('.del-btn').onclick = async () => {
            if(confirm('ยืนยันการลบ?')) await deleteDoc(doc(db, "artifacts", id));
        };

        document.getElementById('movieList').appendChild(tr);
    }

    function resetForm() {
        movieForm.reset();
        document.getElementById('editId').value = '';
        epContainer.innerHTML = '';
        addEpField();
        document.getElementById('cancelBtn').style.display = 'none';
        document.getElementById('submitBtn').innerText = 'บันทึกข้อมูล';
    }
    document.getElementById('cancelBtn').onclick = resetForm;

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = "show";
        setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
    }

    addEpField(); // Start with one field
</script>

</body>
</html>
