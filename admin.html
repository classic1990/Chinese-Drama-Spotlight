<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | DUYDODEE-HD</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00aeff;
            --bg-dark: #0a0a0b;
            --card-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --success: #32d74b;
            --error: #ff453a;
            --ai-color: #8e44ad;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body { margin: 0; font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: var(--text-main); }
        
        #aiLoading { position: fixed; top: 20px; right: 20px; background: var(--ai-color); color: white; padding: 10px 20px; border-radius: 30px; z-index: 1000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; }
        .form-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        @media (max-width: 850px) { .form-grid { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border); }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--text-dim); font-size: 13px; }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border);
            background: var(--input-bg); color: #fff; box-sizing: border-box; font-family: 'Prompt';
        }

        .ai-btn { background: var(--ai-color); color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; }

        .main-save-btn { background: var(--primary); color: #000; padding: 15px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; width: 100%; margin-top: 10px; }

        .episodes-area { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; border: 1px dashed #444; max-height: 250px; overflow-y: auto; }
        .episode-row { display: flex; gap: 8px; margin-bottom: 8px; background: var(--card-bg); padding: 5px; border-radius: 8px; align-items: center; }

        .movie-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .movie-row { background: var(--card-bg); }
        .movie-row td { padding: 12px; border-top: 1px solid var(--glass-border); }
        .poster-mini { width: 40px; height: 55px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>

<div id="aiLoading"><i class="fas fa-magic fa-spin"></i> AI Processing...</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h2><i class="fas fa-robot" style="color:var(--ai-color)"></i> Dashboard</h2>
        <a href="index.html" style="color:var(--text-dim); text-decoration:none;"><i class="fas fa-external-link-alt"></i> ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</a>
    </div>

    <form id="movieForm">
        <div class="form-grid">
            <div class="card">
                <input type="hidden" id="editId">
                <div class="input-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                    <input type="text" id="title" required>
                </div>
                <div class="input-group">
                    <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ <button type="button" class="ai-btn" onclick="aiAction('desc')">AI ‡πÄ‡∏à‡∏ô‡πÉ‡∏´‡πâ</button></label>
                    <textarea id="desc" rows="5"></textarea>
                </div>
                <div class="input-group">
                    <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÉ‡∏™‡πà‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏≠‡∏ô)</label>
                    <div id="episodesContainer" class="episodes-area"></div>
                    <button type="button" class="ai-btn" style="width:100%; margin-top:10px; background:#444;" onclick="addEpisodeInput()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô</button>
                </div>
            </div>

            <div class="card">
                <div class="input-group">
                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="category">
                        <option value="vertical">üì± ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á</option>
                        <option value="series">üé¨ ‡∏û‡∏≤‡∏Å‡∏¢‡πå‡πÑ‡∏ó‡∏¢</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>URL ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå</label>
                    <input type="url" id="poster" required>
                </div>
                <div class="input-group">
                    <label>‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö <button type="button" class="ai-btn" onclick="aiAction('badge')">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button></label>
                    <input type="text" id="badge" placeholder="‡πÄ‡∏ä‡πà‡∏ô HD, ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß">
                </div>
                <button type="submit" class="main-save-btn" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button type="button" id="cancelBtn" onclick="resetForm()" style="display:none; width:100%; margin-top:10px; background:none; color:white; border:none; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </form>

    <div style="margin-top:40px;">
        <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå (${COLLECTION_NAME})</h3>
        <table class="movie-table">
            <tbody id="movieList"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBuhTA1YwcsNyxR0NLYW6JrxUQ9U7vyVeo",
        authDomain: "classic-e8ab7.firebaseapp.com",
        projectId: "classic-e8ab7",
        appId: "1:596308927760:web:63043fd2786459082cb195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const COLLECTION_NAME = "artifacts";
    const geminiKey = "AQ.Ab8RN6I36WcxxlrCTmyr6ChGTr0mpGkfaBMq9nJyVNIqzX90ww";

    // AI Function (Gemini)
    async function aiAction(type) {
        const title = document.getElementById('title').value;
        if(!title) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        
        document.getElementById('aiLoading').style.display = 'block';
        const prompt = type === 'desc' ? `‡∏Ç‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå‡∏à‡∏µ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ${title} ‡∏™‡∏±‡πâ‡∏ô‡πÜ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î` : `‡∏Ç‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö 1 ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ${title}`;
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
                method: 'POST', body: JSON.stringify({contents: [{parts: [{text: prompt}]}]})
            });
            const data = await res.json();
            const result = data.candidates[0].content.parts[0].text.trim();
            if(type === 'desc') document.getElementById('desc').value = result;
            else document.getElementById('badge').value = result.replace(/[^\u0E00-\u0E7F]/g, "");
        } catch(e) { alert("AI Error"); }
        finally { document.getElementById('aiLoading').style.display = 'none'; }
    }

    // Episode Management
    function addEpisodeInput(value = "") {
        const container = document.getElementById('episodesContainer');
        const div = document.createElement('div');
        div.className = 'episode-row';
        div.innerHTML = `
            <input type="text" class="ep-link-input" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠" value="${value}" required>
            <button type="button" onclick="this.parentElement.remove()" style="color:var(--error); background:none; border:none; cursor:pointer;">√ó</button>
        `;
        container.appendChild(div);
    }

    // Form Submit
    document.getElementById('movieForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const links = Array.from(document.getElementsByClassName('ep-link-input')).map(i => i.value.trim());
        
        const data = {
            title: document.getElementById('title').value,
            desc: document.getElementById('desc').value,
            category: document.getElementById('category').value,
            poster: document.getElementById('poster').value,
            badge: document.getElementById('badge').value || "HD",
            links: links,
            link: links[0], // Support single link systems
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if(id) await db.collection(COLLECTION_NAME).doc(id).update(data);
            else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.viewCount = 0;
                await db.collection(COLLECTION_NAME).add(data);
            }
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            resetForm();
        } catch(e) { alert(e.message); }
    });

    function loadData() {
        db.collection(COLLECTION_NAME).orderBy('createdAt', 'desc').onSnapshot(snap => {
            const list = document.getElementById('movieList');
            list.innerHTML = '';
            snap.forEach(doc => {
                const m = doc.data();
                list.innerHTML += `
                    <tr class="movie-row">
                        <td><img src="${m.poster}" class="poster-mini"></td>
                        <td><b>${m.title}</b><br><small>${m.links?.length || 1} ‡∏ï‡∏≠‡∏ô</small></td>
                        <td align="right">
                            <i class="fas fa-edit" onclick="editDoc('${doc.id}')" style="color:var(--primary); cursor:pointer; margin-right:15px;"></i>
                            <i class="fas fa-trash" onclick="deleteDoc('${doc.id}')" style="color:var(--error); cursor:pointer;"></i>
                        </td>
                    </tr>`;
            });
        });
    }

    async function editDoc(id) {
        const doc = await db.collection(COLLECTION_NAME).doc(id).get();
        const m = doc.data();
        document.getElementById('editId').value = id;
        document.getElementById('title').value = m.title;
        document.getElementById('desc').value = m.desc || '';
        document.getElementById('category').value = m.category;
        document.getElementById('poster').value = m.poster;
        document.getElementById('badge').value = m.badge || '';
        document.getElementById('episodesContainer').innerHTML = '';
        if(m.links) m.links.forEach(l => addEpisodeInput(l));
        else addEpisodeInput(m.link);
        
        document.getElementById('submitBtn').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        document.getElementById('cancelBtn').style.display = 'block';
    }

    function resetForm() {
        document.getElementById('movieForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('episodesContainer').innerHTML = '';
        addEpisodeInput();
        document.getElementById('submitBtn').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        document.getElementById('cancelBtn').style.display = 'none';
    }

    async function deleteDoc(id) {
        if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) await db.collection(COLLECTION_NAME).doc(id).delete();
    }

    loadData();
    resetForm();
</script>
</body>
</html>
