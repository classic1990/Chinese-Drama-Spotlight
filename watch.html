<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏° | DUYDODEE-HD</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #00f2ff;
            --bg-dark: #050507;
            --bg-surf: #121216;
            --text-muted: #9ca3af;
            --nav-h: 70px;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: #fff; line-height: 1.6; overflow-x: hidden; }

        /* Navigation */
        nav {
            position: fixed; top: 0; width: 100%; height: var(--nav-h);
            padding: 0 5%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(5, 5, 7, 0.9); backdrop-filter: blur(15px); z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); cursor: pointer; text-decoration: none; text-transform: uppercase; }
        .nav-back { color: var(--text-muted); cursor: pointer; text-decoration: none; font-size: 14px; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-back:hover { color: var(--primary); transform: translateX(-5px); }

        /* Layout */
        .player-layout {
            margin: calc(var(--nav-h) + 25px) auto 60px; padding: 0 5%;
            max-width: 1500px; display: grid; grid-template-columns: 1fr 350px; gap: 35px;
        }

        /* Player & Episodes */
        .video-box { position: relative; padding-bottom: 56.25%; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
        .video-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }

        .ep-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        .ep-btn { 
            background: #1a1a1e; color: var(--text-muted); border: 1px solid #333;
            padding: 8px 18px; border-radius: 8px; cursor: pointer; font-family: inherit; transition: 0.3s;
        }
        .ep-btn.active { background: var(--primary); color: #000; font-weight: 600; border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }

        /* Movie Info */
        .info-card { margin-top: 30px; background: var(--bg-surf); padding: 30px; border-radius: 12px; }
        .m-title { font-size: clamp(20px, 4vw, 28px); margin: 0; font-weight: 700; }
        .meta { display: flex; flex-wrap: wrap; gap: 20px; font-size: 13px; color: var(--text-muted); margin: 20px 0; align-items: center; }
        .badge { background: #ff0055; color: #fff; padding: 2px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .desc { font-size: 14px; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; white-space: pre-line; }

        /* Sidebar Suggestions */
        .side-title { font-size: 18px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 15px; }
        .suggest-card { display: flex; gap: 15px; background: var(--bg-surf); padding: 10px; border-radius: 10px; cursor: pointer; transition: 0.3s; margin-bottom: 15px; border: 1px solid transparent; }
        .suggest-card:hover { transform: translateX(5px); background: #1a1a1e; border-color: rgba(0, 242, 255, 0.2); }
        .suggest-card img { width: 75px; aspect-ratio: 2/3; object-fit: cover; border-radius: 6px; }
        .suggest-card img.vertical { aspect-ratio: 9/16; width: 65px; }
        .suggest-info p { margin: 0; font-size: 14px; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .suggest-info span { font-size: 11px; color: var(--primary); display: block; margin-top: 5px; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-dark); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: 0.4s; }
        .spin { width: 45px; height: 45px; border: 3px solid rgba(255,255,255,0.05); border-top-color: var(--primary); border-radius: 50%; animation: s 0.8s linear infinite; }
        @keyframes s { 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) {
            .player-layout { grid-template-columns: 1fr; }
            .suggest-card { background: transparent; padding: 0; }
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spin"></div>
    <p style="margin-top:20px; font-size:10px; letter-spacing:3px; color: var(--text-muted);">LOADING PLAYER</p>
</div>

<nav>
    <div class="logo" onclick="goHome()">DUY<span style="color:#fff">DODEE</span></div>
    <div class="nav-back" onclick="goHome()"><i class="fas fa-chevron-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
</nav>

<div class="player-layout">
    <main>
        <div class="video-box" id="player-box"></div>
        
        <div class="ep-list-container">
            <p style="font-weight:600; margin-bottom:12px; font-size:14px; margin-top: 20px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ä‡∏°:</p>
            <div class="ep-list" id="ep-list"></div>
        </div>

        <div class="info-card">
            <h1 class="m-title" id="m-title">...</h1>
            <div class="meta">
                <span class="badge" id="m-badge">HD</span>
                <span><i class="far fa-eye" style="color:var(--primary)"></i> <span id="m-views">0</span> ‡∏ß‡∏¥‡∏ß</span>
                <span><i class="fas fa-star" style="color:#ffd700"></i> <span id="m-rating">8.5</span></span>
            </div>
            <div class="desc" id="m-desc">...</div>
        </div>
    </main>

    <aside>
        <h3 class="side-title">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</h3>
        <div id="suggest-box"></div>
    </aside>
</div>

<!-- Firebase Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBuhTA1YwcsNyxR0NLYW6JrxUQ9U7vyVeo",
        authDomain: "classic-e8ab7.firebaseapp.com",
        projectId: "classic-e8ab7",
        appId: "1:596308927760:web:63043fd2786459082cb195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const movieId = new URLSearchParams(window.location.search).get('id');

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Video ID ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö YouTube ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö)
    function getEmbed(u) {
        if (!u || typeof u !== 'string') return "";
        u = u.trim();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô YouTube ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = u.match(regExp);
        
        if (match && match[2].length === 11) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô YouTube ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Embed
            return `https://www.youtube.com/embed/${match[2]}?autoplay=1&rel=0`;
        }
        
        // üí° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà YouTube (‡πÄ‡∏ä‡πà‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå .mp4 ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ
        return u;
    }

    async function init() {
        if(!movieId) { 
            document.getElementById('loader').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</p>';
            return; 
        }
        
        try {
            const docRef = db.collection('artifacts').doc(movieId);
            const doc = await docRef.get();
            
            if(!doc.exists) {
                document.getElementById('loader').innerHTML = '<p>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á</p>';
                return;
            }

            const d = doc.data();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            document.title = `${d.title} | DUYDODEE-HD`;
            document.getElementById('m-title').innerText = d.title;
            document.getElementById('m-badge').innerText = d.badge || 'HD';
            document.getElementById('m-views').innerText = (d.viewCount || 0).toLocaleString();
            document.getElementById('m-rating').innerText = d.rating || '8.5';
            document.getElementById('m-desc').innerText = d.desc || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠";

            const pBox = document.getElementById('player-box');
            const eList = document.getElementById('ep-list');
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö link ‡πÅ‡∏•‡∏∞ links)
            let videoSources = [];
            if (Array.isArray(d.links) && d.links.length > 0) {
                videoSources = d.links;
            } else if (d.link) {
                videoSources = [d.link];
            }

            if(videoSources.length === 0) {
                pBox.innerHTML = `<div style="padding:80px 20px; text-align:center; color:#666;">
                    <i class="fas fa-video-slash" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>
                </div>`;
            } else {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô
                videoSources.forEach((url, i) => {
                    const b = document.createElement('button');
                    b.className = 'ep-btn';
                    b.innerText = videoSources.length > 1 ? `‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${i+1}` : `‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠`;
                    
                    b.onclick = () => {
                        const embedUrl = getEmbed(url);
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ô Iframe
                        pBox.innerHTML = `<iframe src="${embedUrl}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                        
                        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° Active
                        document.querySelectorAll('.ep-btn').forEach(btn => btn.classList.remove('active'));
                        b.classList.add('active');
                    };
                    
                    eList.appendChild(b);
                    
                    // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    if(i === 0) b.click();
                });
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß
            docRef.update({ viewCount: firebase.firestore.FieldValue.increment(1) });
            fetchSuggest(d.category);
            
        } catch(e) { 
            console.error("Error:", e);
            document.getElementById('player-box').innerHTML = `<p style="text-align:center; padding:50px;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}</p>`;
        } finally { 
            const ld = document.getElementById('loader');
            ld.style.opacity = '0';
            setTimeout(() => ld.style.display = 'none', 400);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    async function fetchSuggest(category) {
        const box = document.getElementById('suggest-box');
        try {
            const snap = await db.collection('artifacts').where('category', '==', category).limit(6).get();
            snap.forEach(doc => {
                if(doc.id === movieId) return;
                const m = doc.data();
                const card = document.createElement('div');
                card.className = 'suggest-card';
                card.onclick = () => window.location.href = `watch.html?id=${doc.id}`;
                card.innerHTML = `
                    <img src="${m.poster}" onerror="this.src='https://via.placeholder.com/150x225?text=No+Image'">
                    <div class="suggest-info">
                        <p>${m.title}</p>
                        <span><i class="fas fa-play-circle"></i> ‡∏î‡∏π‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
                    </div>
                `;
                box.appendChild(card);
            });
        } catch(e) { console.log(e); }
    }

    function goHome() { window.location.href = 'index.html'; }

    window.onload = init;
</script>
</body>
</html>
