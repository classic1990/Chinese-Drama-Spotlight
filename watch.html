<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังรับชม | DUYDODEE-HD</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #00f2ff;
            --bg-dark: #050507;
            --bg-surf: #121216;
            --text-muted: #9ca3af;
            --nav-h: 70px;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: #fff; line-height: 1.6; overflow-x: hidden; }

        /* Navigation */
        nav {
            position: fixed; top: 0; width: 100%; height: var(--nav-h);
            padding: 0 5%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(5, 5, 7, 0.9); backdrop-filter: blur(15px); z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); cursor: pointer; text-decoration: none; text-transform: uppercase; }
        .nav-back { color: var(--text-muted); cursor: pointer; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; }

        /* Layout */
        .player-layout {
            margin: calc(var(--nav-h) + 25px) auto 60px; padding: 0 5%;
            max-width: 1500px; display: grid; grid-template-columns: 1fr 350px; gap: 35px;
        }

        /* Video Player Area */
        .video-box { 
            position: relative; padding-bottom: 56.25%; background: #000; 
            border-radius: 12px; overflow: hidden; border: 1px solid #222; 
        }
        .video-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }

        /* VIP Lock UI */
        .vip-lock {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; z-index: 100;
        }
        .btn-login {
            background: var(--primary); color: #000; padding: 12px 30px; 
            border-radius: 50px; text-decoration: none; font-weight: 700; margin-top: 15px;
        }

        .ep-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        .ep-btn { 
            background: #1a1a1e; color: var(--text-muted); border: 1px solid #333;
            padding: 8px 18px; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }
        .ep-btn.active { background: var(--primary); color: #000; font-weight: 600; }

        .info-card { margin-top: 30px; background: var(--bg-surf); padding: 30px; border-radius: 12px; }
        .m-title { font-size: 28px; margin: 0; }
        .desc { font-size: 14px; color: var(--text-muted); margin-top: 20px; white-space: pre-line; }

        /* Sidebar Suggestions */
        .side-title { font-size: 18px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 15px; }
        .suggest-card { display: flex; gap: 15px; background: var(--bg-surf); padding: 10px; border-radius: 10px; cursor: pointer; margin-bottom: 15px; }
        .suggest-card img { width: 70px; aspect-ratio: 2/3; object-fit: cover; border-radius: 6px; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: var(--bg-dark); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: 0.4s; }
        .spin { width: 45px; height: 45px; border: 3px solid rgba(255,255,255,0.05); border-top-color: var(--primary); border-radius: 50%; animation: s 0.8s linear infinite; }
        @keyframes s { 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) { .player-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div></div>

<nav>
    <div class="logo" onclick="goHome()">DUY<span style="color:#fff">DODEE</span></div>
    <div class="nav-back" onclick="goHome()"><i class="fas fa-chevron-left"></i> กลับหน้าหลัก</div>
</nav>

<div class="player-layout">
    <main>
        <div class="video-box" id="player-box"></div>
        
        <div class="ep-list-container">
            <p style="font-weight:600; margin-top: 20px; font-size:14px;">เลือกตอน:</p>
            <div class="ep-list" id="ep-list"></div>
        </div>

        <div class="info-card">
            <h1 class="m-title" id="m-title">...</h1>
            <div style="margin: 15px 0; font-size:13px; color:var(--text-muted);">
                <span id="m-badge" style="background:#ff0055; color:#fff; padding:2px 8px; border-radius:4px; margin-right:10px;">HD</span>
                <span><i class="far fa-eye"></i> <span id="m-views">0</span> วิว</span>
            </div>
            <div class="desc" id="m-desc">...</div>
        </div>
    </main>

    <aside>
        <h3 class="side-title">แนะนำสำหรับคุณ</h3>
        <div id="suggest-box"></div>
    </aside>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBuhTA1YwcsNyxR0NLYW6JrxUQ9U7vyVeo",
        authDomain: "classic-e8ab7.firebaseapp.com",
        projectId: "classic-e8ab7",
        appId: "1:596308927760:web:63043fd2786459082cb195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const movieId = new URLSearchParams(window.location.search).get('id');

    function getEmbed(url) {
        if (!url) return "";
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length === 11) {
            return `https://www.youtube.com/embed/${match[2]}?autoplay=1&rel=0`;
        }
        return url;
    }

    async function init() {
        if(!movieId) { window.location.href = 'index.html'; return; }
        
        try {
            const docRef = db.collection('artifacts').doc(movieId);
            const doc = await docRef.get();
            if(!doc.exists) { alert("ไม่พบข้อมูล"); return; }

            const d = doc.data();

            auth.onAuthStateChanged(user => {
                if (d.isVip && !user) {
                    document.getElementById('player-box').innerHTML = `
                        <div class="vip-lock">
                            <i class="fas fa-lock" style="font-size:50px; color:var(--primary); margin-bottom:15px;"></i>
                            <h3>เนื้อหาเฉพาะสมาชิก VIP</h3>
                            <p>กรุณาเข้าสู่ระบบเพื่อรับชมเรื่องนี้</p>
                            <a href="login.html" class="btn-login">เข้าสู่ระบบตอนนี้</a>
                        </div>
                    `;
                    // ปิด Loader แม้จะติด VIP
                    document.getElementById('loader').style.display = 'none';
                    return;
                }
                loadVideoContent(d, docRef);
            });

        } catch(e) { console.error(e); }
    }

    function loadVideoContent(d, docRef) {
        document.getElementById('m-title').innerText = d.title;
        document.getElementById('m-badge').innerText = d.badge || 'HD';
        document.getElementById('m-views').innerText = (d.viewCount || 0).toLocaleString();
        document.getElementById('m-desc').innerText = d.desc || "ไม่มีเรื่องย่อ";

        const pBox = document.getElementById('player-box');
        const eList = document.getElementById('ep-list');
        
        let links = Array.isArray(d.links) ? d.links : (d.link ? [d.link] : []);

        if(links.length === 0) {
            pBox.innerHTML = `<p style="text-align:center; padding-top:100px;">ไม่พบไฟล์วิดีโอ</p>`;
        } else {
            links.forEach((url, i) => {
                const b = document.createElement('button');
                b.className = 'ep-btn';
                b.innerText = links.length > 1 ? `ตอนที่ ${i+1}` : `เล่นวิดีโอ`;
                b.onclick = () => {
                    pBox.innerHTML = `<iframe src="${getEmbed(url)}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                    document.querySelectorAll('.ep-btn').forEach(btn => btn.classList.remove('active'));
                    b.classList.add('active');
                };
                eList.appendChild(b);
                if(i === 0) b.click();
            });
        }

        docRef.update({ viewCount: firebase.firestore.FieldValue.increment(1) });
        fetchSuggest(d.category);
        document.getElementById('loader').style.display = 'none';
    }

    async function fetchSuggest(cat) {
        const box = document.getElementById('suggest-box');
        const snap = await db.collection('artifacts').where('category', '==', cat).limit(6).get();
        snap.forEach(doc => {
            if(doc.id === movieId) return;
            const m = doc.data();
            const d = document.createElement('div');
            d.className = 'suggest-card';
            d.onclick = () => window.location.href = `watch.html?id=${doc.id}`;
            d.innerHTML = `<img src="${m.poster}"><div class="s-info"><p style="font-size:14px; margin:0;">${m.title}</p></div>`;
            box.appendChild(d);
        });
    }

    function goHome() { window.location.href = 'index.html'; }

    init();
</script>
</body>
</html>
