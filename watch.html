<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังรับชม | DUYDODEE-HD</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #00f2ff;
            --bg-dark: #050507;
            --bg-surf: #121216;
            --text-muted: #9ca3af;
            --nav-h: 70px;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: #fff; line-height: 1.6; overflow-x: hidden; }

        /* Navigation */
        nav {
            position: fixed; top: 0; width: 100%; height: var(--nav-h);
            padding: 0 5%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(5, 5, 7, 0.9); backdrop-filter: blur(15px); z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); cursor: pointer; text-decoration: none; text-transform: uppercase; }
        .nav-back { color: var(--text-muted); cursor: pointer; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; }

        /* Layout */
        .player-layout {
            margin: calc(var(--nav-h) + 25px) auto 60px; padding: 0 5%;
            max-width: 1500px; display: grid; grid-template-columns: 1fr 350px; gap: 35px;
        }

        /* Video Player Area */
        .video-box { 
            position: relative; padding-bottom: 56.25%; background: #000; 
            border-radius: 12px; overflow: hidden; border: 1px solid #222; 
        }
        .video-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }

        /* VIP Lock UI */
        .vip-lock {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; z-index: 100;
        }
        .btn-login {
            background: var(--primary); color: #000; padding: 12px 30px; 
            border-radius: 50px; text-decoration: none; font-weight: 700; margin-top: 15px;
        }

        .ep-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 25px; }
        .ep-btn { 
            background: #1a1a1e; color: var(--text-muted); border: 1px solid #333;
            padding: 8px 18px; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }
        .ep-btn.active { background: var(--primary); color: #000; font-weight: 600; }

        .info-card { margin-top: 30px; background: var(--bg-surf); padding: 30px; border-radius: 12px; }
        .m-title { font-size: 28px; margin: 0; }
        .desc { font-size: 14px; color: var(--text-muted); margin-top: 20px; white-space: pre-line; }

        /* Sidebar Suggestions */
        .side-title { font-size: 18px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 15px; }
        .suggest-card { display: flex; gap: 15px; background: var(--bg-surf); padding: 10px; border-radius: 10px; cursor: pointer; margin-bottom: 15px; transition: 0.3s; }
        .suggest-card:hover { background: #1f1f25; }
        .suggest-card img { width: 70px; aspect-ratio: 2/3; object-fit: cover; border-radius: 6px; }

        #loader { position: fixed; inset: 0; background: var(--bg-dark); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: 0.4s; }
        .spin { width: 45px; height: 45px; border: 3px solid rgba(255,255,255,0.05); border-top-color: var(--primary); border-radius: 50%; animation: s 0.8s linear infinite; }
        @keyframes s { 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) { 
            .player-layout { grid-template-columns: 1fr; } 
            .suggest-card img { width: 60px; }
        }
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div></div>

<nav>
    <div class="logo" onclick="goHome()">DUY<span style="color:#fff">DODEE</span></div>
    <div class="nav-back" onclick="goHome()"><i class="fas fa-chevron-left"></i> กลับหน้าหลัก</div>
</nav>

<div class="player-layout">
    <main>
        <div class="video-box" id="player-box"></div>
        
        <div class="ep-list-container">
            <p style="font-weight:600; margin-top: 25px; font-size:14px; color:var(--primary);">
                <i class="fas fa-list-ol"></i> เลือกตอนที่ต้องการรับชม:
            </p>
            <div class="ep-list" id="ep-list"></div>
        </div>

        <div class="info-card">
            <h1 class="m-title" id="m-title">...</h1>
            <div style="margin: 15px 0; font-size:13px; color:var(--text-muted);">
                <span id="m-badge" style="background:#ff0055; color:#fff; padding:2px 8px; border-radius:4px; margin-right:10px; font-weight:bold;">HD</span>
                <span><i class="far fa-eye"></i> <span id="m-views">0</span> วิว</span>
            </div>
            <div class="desc" id="m-desc">...</div>
        </div>
    </main>

    <aside>
        <h3 class="side-title">แนะนำสำหรับคุณ</h3>
        <div id="suggest-box"></div>
    </aside>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBuhTA1YwcsNyxR0NLYW6JrxUQ9U7vyVeo",
        authDomain: "classic-e8ab7.firebaseapp.com",
        projectId: "classic-e8ab7",
        appId: "1:596308927760:web:63043fd2786459082cb195"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const movieId = new URLSearchParams(window.location.search).get('id');

    // แปลงลิงก์ YouTube ให้เป็น Embed
    function getEmbed(url) {
        if (!url) return "";
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length === 11) {
            return `https://www.youtube.com/embed/${match[2]}?autoplay=1&rel=0&modestbranding=1`;
        }
        return url;
    }

    async function init() {
        if(!movieId) { window.location.href = 'index.html'; return; }
        
        try {
            const docRef = db.collection('artifacts').doc(movieId);
            const doc = await docRef.get();
            
            if(!doc.exists) { 
                alert("ไม่พบข้อมูลซีรีส์เรื่องนี้"); 
                window.location.href = 'index.html';
                return; 
            }

            const data = doc.data();

            // เช็คสถานะ Login และ VIP
            auth.onAuthStateChanged(user => {
                if (data.isVip && !user) {
                    showVipLock();
                    hideLoader();
                } else {
                    renderContent(data, docRef);
                }
            });

        } catch(e) { 
            console.error("Init Error:", e);
            hideLoader();
        }
    }

    function showVipLock() {
        document.getElementById('player-box').innerHTML = `
            <div class="vip-lock">
                <i class="fas fa-crown" style="font-size:60px; color:var(--primary); margin-bottom:15px; filter: drop-shadow(0 0 10px rgba(0,242,255,0.5));"></i>
                <h2 style="margin:10px 0;">เนื้อหาเฉพาะสมาชิก VIP</h2>
                <p style="color:var(--text-muted); max-width:250px;">ซีรีส์เรื่องนี้จำกัดสิทธิ์เฉพาะสมาชิกเท่านั้น กรุณาเข้าสู่ระบบ</p>
                <a href="login.html" class="btn-login">เข้าสู่ระบบ / สมัครสมาชิก</a>
            </div>
        `;
    }

    function renderContent(data, docRef) {
        // อัปเดตข้อมูลพื้นฐาน
        document.getElementById('m-title').innerText = data.title;
        document.getElementById('m-badge').innerText = data.badge || 'HD';
        document.getElementById('m-views').innerText = (data.viewCount || 0).toLocaleString();
        document.getElementById('m-desc').innerText = data.desc || "ไม่มีเรื่องย่อสำหรับซีรีส์เรื่องนี้";

        const pBox = document.getElementById('player-box');
        const eList = document.getElementById('ep-list');
        
        // จัดการลิงก์วิดีโอ (รองรับทั้ง links array และ link string)
        let links = Array.isArray(data.links) ? data.links : (data.link ? [data.link] : []);

        if(links.length === 0) {
            pBox.innerHTML = `<p style="text-align:center; padding-top:100px; color:var(--text-muted);">ขออภัย ไม่พบไฟล์วิดีโอในระบบ</p>`;
        } else {
            links.forEach((url, i) => {
                const btn = document.createElement('button');
                btn.className = 'ep-btn';
                btn.innerText = links.length > 1 ? `ตอนที่ ${i+1}` : `เล่นวิดีโอ`;
                
                btn.onclick = () => {
                    pBox.innerHTML = `<iframe src="${getEmbed(url)}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                    document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                
                eList.appendChild(btn);
                if(i === 0) btn.click(); // เล่นตอนแรกอัตโนมัติ
            });
        }

        // เพิ่มยอดวิว + โหลดหนังแนะนำ
        docRef.update({ viewCount: firebase.firestore.FieldValue.increment(1) });
        fetchSuggest(data.category);
        hideLoader();
    }

    async function fetchSuggest(cat) {
        const box = document.getElementById('suggest-box');
        try {
            const snap = await db.collection('artifacts')
                .where('category', '==', cat)
                .limit(6)
                .get();

            snap.forEach(doc => {
                if(doc.id === movieId) return; // ไม่แสดงเรื่องที่กำลังดู
                const m = doc.data();
                const d = document.createElement('div');
                d.className = 'suggest-card';
                d.onclick = () => window.location.href = `watch.html?id=${doc.id}`;
                d.innerHTML = `
                    <img src="${m.poster}" loading="lazy">
                    <div class="s-info">
                        <p style="font-size:14px; margin:0; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${m.title}</p>
                        <span style="font-size:11px; color:var(--primary);">${m.badge || 'พากย์ไทย'}</span>
                    </div>
                `;
                box.appendChild(d);
            });
        } catch(e) { console.error("Suggest Error:", e); }
    }

    function hideLoader() {
        const loader = document.getElementById('loader');
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 500);
    }

    function goHome() { window.location.href = 'index.html'; }

    // เริ่มทำงาน
    init();
</script>
</body>
</html>
